---
title: 2 Niche Overlap Analysis using nicheROVER
author:
  - first_name: "Zhehao"
    last_name: "Hu"
    url: https://github.com/zzzhehao
    affiliation: Universität Hamburg
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 8pt
bibliography:
  - "`r system('kpsewhich ../../../../005\\ Tools/Academic/Bib/MSc.bib', intern=TRUE)`"
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    highlight: rstudio
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../Distill"
    )
  })
---

A new probabilistic method for quantifing n-dimensional ecological niche and niche overlap [@swanson2015].

# Niche Region and Niche Overlap Metrics

This script is written by Martin Lysy, Heidi Swanson and can be found [here](https://cran.r-project.org/web/packages/nicheROVER/vignettes/ecol-vignette.html), it requires the package "nicheROVER", which can be installed directly from CRAN.

```{r setup, include=FALSE}
library(nicheROVER)
library(rmarkdown)
```

"Fish" is a **fish stable isotope dataset** integrated in the package, containing values for three stable isotopes (N-15, C-13, S-34) measured in the muscle tissue of four species of arctic fish (ARCS, BDWF, LKWF, LSCS). Use `?fish` for more details.

```{r paged.print=TRUE}
data(fish)
paged_table(fish)
```

A brief view into the mean of isotope for each species.

```{r}
aggregate(fish[2:4], fish[1], mean)
```

## Simulating random data

The script uses `niw.post()` (random drawing from the posterior distribution with the Normal-Inverse-Wishart prior) to draw simulated data points.

### Terminologies

#### Bayesian statistics

@vandeschoot2021 described the very foundation idea of the bayesian statistics as following:

Bayesian statistics is an approach to data analysis based on Bayes' theorem, where available knowledge about parameters in a statistical model is updated with the information in observed data. The background knowledge is expressed as a **prior** distribution and combined with observational data in the form of a likelihood function to determine the **posterior distribution**.

### Normal-Inverse-Wishart (NIW) distribution

$$
P(x |\text{species}=s) \backsim N(\mu_s \, , \Sigma_s)
$$

**An explanation from [datamicroscope](https://datamicroscopes.github.io/niw.html#:~:text=Since%20the%20normal%20inverse%2DWishart,when%20we%20define%20our%20model.)**:

In practice, real valued data is commonly assumed to be distributed normally, or Gaussian. We could assume that conditioned on species, the measurement data followed a multivariate normal (above mentioned).

The normal inverse-Wishart distribution allows us to learn the underlying parameters of each normal distribution, its mean μs and its covariance $\Sigma_s$. Since the normal inverse-Wishart is the conjugate prior of the multivariate normal, the posterior distribution of a multivariate normal with a normal inverse-Wishart prior also follows a normal inverse-Wishart distribution. This allows us to infer the distirbution over values of $\mu_s$ and $\Sigma_s$ when we define our model.

**The explanation from [wikipedia](https://en.wikipedia.org/wiki/Inverse-Wishart_distribution#:~:text=In%20statistics%2C%20the%20inverse%20Wishart,of%20a%20multivariate%20normal%20distribution.)**:

In statistics, the inverse Wishart distribution, also called the inverted Wishart distribution, is a probability distribution defined on real-valued positive-definite matrices. In Bayesian statistics it is used as the conjugate prior for the covariance matrix of a multivariate normal distribution.

**Another explanation from [arxiv](https://arxiv.org/html/2405.16088v1#)**:

The normal-inverse-Wishart (NIW) distribution is commonly used as a prior distribution for the mean ($\mu$) and covariance ($\Sigma$) parameters of a multivariate normal distribution.

**My explanation of this formula**:

The probability of finding a specie given a normal distribution ($N$) of $\mu$ as niche parameter mean and $\Sigma$ as niche parameter covariance.

### Drawing with `niw.post()`

```{r paged.print=TRUE}
# generate parameter draws from the "default" posteriors of each species
nsamples <- 1000
fish.par <- tapply(1:nrow(fish), fish$species,
            function(ii) niw.post(nsamples = nsamples, X = fish[ii,2:4]))
```

This resamples `nsamples`=`r nsamples` times from NIW distribution for each row in `fish` to generate the simulation data. As we categorized the observation by `fish$species`, we obtain a list of 4 with each of them containing a `nsample` long vector of $\mu$ and $\Sigma$ based on NIW distribution given the original data.

```{r}
# simulation data of the first specie
# num [1:3, 1:3, 1:1000] means a 3x3x1000 multi-dimentional array
str(fish.par[[1]])
```

This step and data structure is critical to later apply `niche.par.plot()`. For such reason, this step can be stored as a function for later utilization:

```{r niche.par.function}
niche.par <- function(data, index, n, pars) {
  par <- tapply(1:nrow(data), INDEX = index,
                function(r) niw.post(nsamples = n, X = data[r, pars]))
}
```

## Visualizing niche parameters

As mentioned above, the description (`?niche.par.plot()`) states the first argument has to be a *list with nspecies = length(niche.par), each element of which is a list with parameters mu and Sigma*. Use `plot.index`, `plot.mu` or `plot.Sigma` to select which $\mu$ or $\Sigma$ to plot, see details in the document.

```{r fig.height=2, fig.align="left"}
clrs <- c("black", "red", "blue", "orange") # colors for each species

# mu1 (del15N), mu2 (del13C), and Sigma12 
par(mar = c(4, 5, .5, .1)+.1, oma = c(0,0,0,0), pty="s", mfrow = c(1,3))
niche.par.plot(fish.par, col = clrs, plot.index = 1)
niche.par.plot(fish.par, col = clrs, plot.index = 2)
niche.par.plot(fish.par, col = clrs, plot.index = 1:2)
legend("topleft", legend = names(fish.par), fill = clrs)
```

### Plot intepretation

## 2-d projection of a subset of a niche region

```{r fig.height=9, fig.width=9, fig.align="center"}
nsamples <- 10 
fish.par <- tapply(1:nrow(fish), fish$species,
                   function(ii) niw.post(nsamples = nsamples, X = fish[ii,2:4]))

# format data for plotting function
fish.data <- tapply(1:nrow(fish), fish$species, function(ii) X = fish[ii,2:4])

niche.plot(niche.par = fish.par, niche.data = fish.data, pfrac = .05,
           iso.names = expression(delta^{15}*N, delta^{13}*C, delta^{34}*S),
           col = clrs, xlab = expression("Isotope Ratio (per mil)"))
```
